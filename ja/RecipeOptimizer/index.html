<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>レシピ作成最大化ツール</title>
<style>
body { font-family: sans-serif; padding: 20px; margin:0; box-sizing:border-box; }
.wrapper { width: 100%; max-width: 100%; overflow-x: auto; }
.stock-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
.stock-container div { display: flex; align-items: center; gap: 5px; }
.material-name {
  display: flex;
}
input { width: 60px; }
table { border: 1px solid #ccc; border-collapse: collapse; width: 100%; max-width: 100%; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
th { background-color: #f0f0f0; }
tr.highlight { background-color: #f9f9e5; }
.count-box { width: 40px; text-align: center; }
button.small-btn { padding: 2px 6px; margin: 0 2px; }
@media (max-width: 600px) {
  .stock-container { flex-direction: column; }
  input { width: 50px; }
  table { font-size: 12px; }
}
</style>
</head>
<body>
<div class="wrapper">
<h2>レシピ作成最大化ツール</h2>

<h3>所持食材数を入力</h3>
<div class="stock-container">
  <div class="material-name">
    <img src="img/meat.png" width="27" height="27">
    <div>肉: <input type="number" id="stock_meat" value="" min="0"></div>
  </div>
  <div class="material-name">
    <img src="img/fish.png" width="27" height="27">
    <div>魚: <input type="number" id="stock_fish" value="" min="0"></div>
  </div>
  <div class="material-name">
    <img src="img/carrot.png" width="27" height="27">
    <div>人参: <input type="number" id="stock_carrot" value="" min="0"></div>
  </div>
  <div class="material-name">
    <img src="img/salt.png" width="27" height="27">
    <div>塩: <input type="number" id="stock_salt" value="" min="0"></div>
  </div>
  <div class="material-name">
    <img src="img/water.png" width="27" height="27">
    <div>水: <input type="number" id="stock_water" value="" min="0"></div>
  </div>
</div>
<button id="calculateBtn">計算</button>

<span id="calculate_msg"></span>

<h3>料理一覧（消費素材数 + 調理回数）</h3>
<table id="recipe_table">
<tr>
  <th>料理</th>
  <th>肉</th>
  <th>魚</th>
  <th>人参</th>
  <th>塩</th>
  <th>水</th>
  <th>作成回数（計算）</th>
  <th>実際作成</th>
</tr>
</table>

<h3>余った食材</h3>
<ul id="leftover_list"></ul>

<h3>作成可能な合計数</h3>
<div id="total_possible">0</div>
</div>

<script type="module">
import GLPK from "./lib/index.js";

const recipes = {
  炭火焼き魚: {肉:0, 魚:30, 人参:5, 塩:15, 水:0},
  炭火焼きリブ: {肉:30, 魚:0, 人参:5, 塩:15, 水:0},
  炭火焼き野菜: {肉:0, 魚:0, 人参:30, 塩:15, 水:5},
  風味豊かな魚: {肉:0, 魚:25, 人参:0, 塩:15, 水:5},
  風味豊かな肉: {肉:25, 魚:0, 人参:0, 塩:15, 水:5},
  風味豊かな野菜: {肉:0, 魚:0, 人参:25, 塩:15, 水:5},
  タラのスープ: {肉:0, 魚:15, 人参:0, 塩:5, 水:20},
  煮込みリブ: {肉:15, 魚:0, 人参:5, 塩:0, 水:20},
  濃厚な野菜スープ: {肉:0, 魚:0, 人参:15, 塩:5, 水:20},
  塩漬けニシン: {肉:0, 魚:15, 人参:5, 塩:5, 水:0},
  塩漬け干し肉: {肉:15, 魚:0, 人参:5, 塩:5, 水:0},
  蒸しシーフード盛り合わせ: {肉:0, 魚:15, 人参:5, 塩:0, 水:10},
  焼肉盛り合わせ: {肉:15, 魚:0, 人参:5, 塩:10, 水:0},
  美味しい野菜盛り合わせ: {肉:0, 魚:0, 人参:15, 塩:5, 水:10},
  ご馳走盛り合わせ: {肉:0, 魚:5, 人参:15, 塩:10, 水:0}
};

let actualCounts = {};

function updateHighlight(element) {
  const calculatedCount = parseInt(element.closest('tr').children[6].innerHTML);
  if(element.value >= calculatedCount) {
    element.closest('tr').classList.remove('highlight');
  }
  if(element.value < calculatedCount && !element.closest('tr').classList.contains('highlight')) {
    element.closest('tr').classList.add('highlight');
  }
}

function showRecipeTable(counts={}) {
  const table = document.getElementById('recipe_table');
  table.innerHTML = "<tr><th>料理</th><th>肉</th><th>魚</th><th>人参</th><th>塩</th><th>水</th><th>作成回数（計算）</th><th>実際作成</th></tr>";

  let totalCount = 0;

  for (let r in recipes) {
    if (!(r in actualCounts)) actualCounts[r] = 0;
    const tr = document.createElement('tr');
    const count = counts[r] || 0;
    totalCount += count;

    // 作成回数が1以上の場合はハイライト
    if (count > 0) {
      tr.classList.add("highlight");
    }

    // 実際作成カウント部分のDOM作成
    const tdActual = document.createElement('td');
    
    const btnMinus = document.createElement('button');
    btnMinus.textContent = "-";
    btnMinus.className = "small-btn";
    btnMinus.onclick = () => {
      actualCounts[r] = Math.max(0, actualCounts[r] - 1);
      input.value = actualCounts[r];
      updateHighlight(input);
    };
    
    const input = document.createElement('input');
    input.type = "number";
    input.value = actualCounts[r];
    input.className = "count-box";
    input.min = "0";
    input.onchange = () => {
      actualCounts[r] = parseInt(input.value) || 0;
      updateHighlight(input);
    };
    
    const btnPlus = document.createElement('button');
    btnPlus.textContent = "+";
    btnPlus.className = "small-btn";
    btnPlus.onclick = () => {
      actualCounts[r]++;
      input.value = actualCounts[r];
      updateHighlight(input);
    };
    
    tdActual.appendChild(btnMinus);
    tdActual.appendChild(input);
    tdActual.appendChild(btnPlus);

    tr.innerHTML = `<td>${r}</td>
                    <td>${recipes[r].肉}</td>
                    <td>${recipes[r].魚}</td>
                    <td>${recipes[r].人参}</td>
                    <td>${recipes[r].塩}</td>
                    <td>${recipes[r].水}</td>
                    <td>${count}</td>`;
    
    tr.appendChild(tdActual);
    table.appendChild(tr);
  }

  // 合計作成可能数を表示
  document.getElementById('total_possible').textContent = totalCount;

  if (totalCount > 0) {
    document.getElementById('calculate_msg').textContent = "計算が完了しました";
  } else {
    document.getElementById('calculate_msg').textContent = "作成できる料理はありません";
  }
}

async function calculate() {
  const glpk = await GLPK();

  const stock = {
    肉: parseInt(document.getElementById('stock_meat').value) || 0,
    魚: parseInt(document.getElementById('stock_fish').value) || 0,
    人参: parseInt(document.getElementById('stock_carrot').value) || 0,
    塩: parseInt(document.getElementById('stock_salt').value) || 0,
    水: parseInt(document.getElementById('stock_water').value) || 0
  };

  const recipeNames = Object.keys(recipes);

  // 1. LP最適化（素材消費少ないレシピ優先）
  const lp = { 
    name:'RecipeOptimization', 
    objective:{ direction: glpk.GLP_MAX, name:'total', vars:[] }, 
    subjectTo:[]
  };

  recipeNames.forEach(r => {
    const total = Object.values(recipes[r]).reduce((a,b)=>a+b,0);
    lp.objective.vars.push({ name:r, coef:1/total });
  });

  ['肉','魚','人参','塩','水'].forEach(mat => {
    const cons = { name: mat, vars: [], bnds:{ type: glpk.GLP_UP, ub: stock[mat], lb:0 } };
    recipeNames.forEach(r => cons.vars.push({ name:r, coef: recipes[r][mat] }));
    lp.subjectTo.push(cons);
  });

  let result;
  try { 
    result = await glpk.solve(lp, { msglev: glpk.GLP_MSG_OFF }); 
  } 
  catch(err) { 
    console.error(err); 
    alert("計算中にエラーが発生しました。"); 
    return; 
  }

  // 2. 整数部分だけ切り捨て
  const counts = {};
  recipeNames.forEach(r => counts[r] = Math.floor(result.result.vars[r] || 0));

  // 3. 余り計算
  let leftover = {...stock};
  for (let r in counts) {
    const count = counts[r];
    for (let mat in recipes[r]) {
      leftover[mat] -= recipes[r][mat]*count;
    }
  }

  // 4. 残余素材で再調理（素材消費少ない順優先）
  while(true) {
    let bestRecipe = null;
    let bestCount = 0;
    let bestScore = Infinity;

    recipeNames.forEach(r => {
      let maxCount = Infinity;
      let score = Object.values(recipes[r]).reduce((a,b)=>a+b,0);
      for(let mat in recipes[r]) {
        if(recipes[r][mat]>0) maxCount = Math.min(maxCount, Math.floor(leftover[mat]/recipes[r][mat]));
      }
      if(maxCount <=0) return;
      if(score < bestScore || (score === bestScore && maxCount > bestCount)){
        bestScore = score;
        bestCount = maxCount;
        bestRecipe = r;
      }
    });

    if(!bestRecipe) break;

    counts[bestRecipe] += bestCount;
    for(let mat in recipes[bestRecipe]){
      leftover[mat] -= recipes[bestRecipe][mat]*bestCount;
    }
  }

  // 5. 結果表示
  showRecipeTable(counts);

  const ul = document.getElementById('leftover_list');
  ul.innerHTML = '';
  for (let mat in leftover) {
    const li = document.createElement('li');
    li.textContent = `${mat}: ${leftover[mat]}`;
    ul.appendChild(li);
  }

  // カウントリセット
  let countBoxes = Array.from(document.getElementsByClassName('count-box'));
  countBoxes.forEach(input => input.value = 0);

  for (let r in actualCounts) {
    actualCounts[r] = 0;
  }
}

document.getElementById('calculateBtn').addEventListener('click', calculate);
showRecipeTable();
</script>
</body>
</html>
