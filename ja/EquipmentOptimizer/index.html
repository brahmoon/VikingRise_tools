<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Logger Example</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6LcrZMQrAAAAABr2uYU5F53pEG46ZnU4LYxXXzWH"></script>
</head>
<body>
    <div id="status">ページを読み込んでいます...</div>
    
    <script>
        // 設定
        const CONFIG = {
            RECAPTCHA_SITE_KEY: '6LcrZMQrAAAAABr2uYU5F53pEG46ZnU4LYxXXzWH',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwLLdE1nRN61otvJCz5GXcCv4BwRO5-rZygWXS0bRl_eYb2dtV3llA0cLpU4LA5tz6z/exec',
            ALLOWED_ORIGINS: ['https://brahmoon.github.io']
        };

        /**
         * URLクエリパラメータを解析する
         */
        function parseQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                game_id: params.get('game_id'),
                char_id: params.get('char_id')
            };
        }

        /**
         * 必要なクエリパラメータが存在するかチェック
         */
        function validateParams(params) {
            return params.code && params.game_id && params.char_id;
        }

        /**
         * reCAPTCHAトークンを取得
         */
        async function getReCaptchaToken() {
            try {
                return await grecaptcha.execute(CONFIG.RECAPTCHA_SITE_KEY, { action: 'log_query' });
            } catch (error) {
                console.error('reCAPTCHA token generation failed:', error);
                throw error;
            }
        }

        /**
         * フォームを使用してデータをApps Scriptに送信（CORS回避）
         */
        async function sendToAppsScriptViaForm(data) {
            return new Promise((resolve, reject) => {
                try {
                    // 非表示のフォームを作成
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = CONFIG.APPS_SCRIPT_URL;
                    form.target = 'response_iframe';
                    form.style.display = 'none';

                    // データをフォームフィールドとして追加
                    for (const [key, value] of Object.entries(data)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        form.appendChild(input);
                    }

                    // レスポンス受信用のiframeを作成
                    const iframe = document.createElement('iframe');
                    iframe.name = 'response_iframe';
                    iframe.style.display = 'none';
                    
                    // iframeのロード完了時の処理
                    iframe.onload = function() {
                        try {
                            setTimeout(() => {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                const responseText = iframeDoc.body.textContent || iframeDoc.body.innerText;
                                
                                // JSONレスポンスをパース
                                let result;
                                try {
                                    result = JSON.parse(responseText);
                                } catch (e) {
                                    // HTMLレスポンスの場合、JSONを抽出
                                    const jsonMatch = responseText.match(/{"success":[^}]+}/);
                                    if (jsonMatch) {
                                        result = JSON.parse(jsonMatch[0]);
                                    } else {
                                        result = { success: false, message: 'Invalid response format' };
                                    }
                                }
                                
                                // クリーンアップ
                                document.body.removeChild(form);
                                document.body.removeChild(iframe);
                                
                                resolve(result);
                            }, 1000);
                        } catch (error) {
                            console.error('Error processing iframe response:', error);
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                            reject(error);
                        }
                    };

                    iframe.onerror = function() {
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        reject(new Error('Failed to load response iframe'));
                    };

                    // DOM に追加してフォームを送信
                    document.body.appendChild(form);
                    document.body.appendChild(iframe);
                    form.submit();

                } catch (error) {
                    console.error('Error in sendToAppsScriptViaForm:', error);
                    reject(error);
                }
            });
        }

        /**
         * データをApps Scriptに送信（fetch API使用、CORS制限あり）
         */
        async function sendToAppsScript(data) {
            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Fetch failed, trying form submission:', error);
                // fetchが失敗した場合はフォーム送信を試す
                return await sendToAppsScriptViaForm(data);
            }
        }

        /**
         * ステータス表示を更新
         */
        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.style.color = isError ? 'red' : 'green';
        }

        /**
         * メイン処理
         */
        async function main() {
            try {
                // URLクエリパラメータを取得
                const params = parseQueryParams();
                
                // パラメータが存在しない場合は処理を終了
                if (!validateParams(params)) {
                    updateStatus('必要なクエリパラメータ（code, game_id, char_id）が見つかりません。');
                    return;
                }

                updateStatus('データを送信しています...');

                // reCAPTCHAトークンを取得
                const recaptchaToken = await getReCaptchaToken();

                // 送信データを準備
                const dataToSend = {
                    code: params.code,
                    game_id: params.game_id,
                    char_id: params.char_id,
                    origin: window.location.origin,
                    referer: window.location.href,
                    recaptchaToken: recaptchaToken
                };

                // Apps Scriptに送信
                const result = await sendToAppsScript(dataToSend);

                if (result && result.success) {
                    updateStatus('データが正常に保存されました。');
                } else {
                    updateStatus(`エラー: ${result?.message || '不明なエラーが発生しました。'}`, true);
                }

            } catch (error) {
                console.error('Main process error:', error);
                updateStatus('処理中にエラーが発生しました。', true);
            }
        }

        // reCAPTCHAが読み込まれた後にメイン処理を実行
        grecaptcha.ready(function() {
            main();
        });
    </script>
</body>
</html>
